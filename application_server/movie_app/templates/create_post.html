{% extends 'base.html' %}
{% block title %} Write a Post | CineNote {% endblock %}

{% block body %}

<div class="jumbotron jumbotron-fluid">
    <div class="container-fluid" style="margin-top: -40px; background: white; box-shadow: 1px 1px 10px 1px black; padding: 10px; width: 800px;">
        <form id="postForm" action="{% url 'post_created' %}" method="post">
            {% csrf_token %}
            <h1>Write a Post</h1>
            <hr>
            <div class="form-group">
                <label for="exampleInputEmail1">Title</label>
                <input type="text" style="border:1px solid;" name="title" class="form-control" style="width: 400px;" id="exampleInputEmail1" aria-describedby="emailHelp" required>
            </div>
            <div class="form-group">
                <label for="webLink">Web Link</label>
                <input type="text" style="border:1px solid;" name="webLink" class="form-control" style="width: 400px;" id="webLink" placeholder="Enter web link">
            </div>
            <div class="form-group">
                <label for="tags">Semantic Tags</label>
                <input type="text" style="border:1px solid;" name="tags" class="form-control" style="width: 400px;" id="tags" placeholder="Enter semantic tags (comma separated)">
            </div>
            <div id="tagInfo">
            </div>
            <div class="form-group">
                <label for="exampleInputPassword1">Content</label>
                <textarea style="height: 300px; border: 1px solid;" name="content" class="form-control" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Publish</button>
        </form>
    </div>
</div>

<<script>
    $(document).ready(function () {
        $('#tags').on('input', getWikidataInfo);
    });

    function getWikidataInfo(event) {
        var tags = event.target.value.split(',').map(tag => tag.trim());
        var tagInfoDiv = $('#tagInfo');
        tagInfoDiv.empty();  // Clear old tags

        tags.forEach(tag => {
            $.ajax({
                url: 'https://www.wikidata.org/w/api.php',
                data: {
                    action: 'wbsearchentities',
                    language: 'en',
                    format: 'json',
                    search: tag
                },
                dataType: 'jsonp',
                success: function (data) {
                    if (data.search.length > 0) {
                        var selectId = "desc_" + tag.replace(/ /g, "_");  // Replace spaces with underscores
                        var tagInfo = `<p><strong>${tag}</strong>: <select id="${selectId}">`;
                        for (let result of data.search) {
                            if (result.description) { // Check if the description exists before adding it to options
                                tagInfo += `<option value="${result.id}">${result.description}</option>`;
                            }
                        }
                        tagInfo += `</select></p>`;
                        tagInfoDiv.append(tagInfo);
                        var hiddenInputId = "hidden_" + tag.replace(/ /g, "_");
                        tagInfoDiv.append(`<input type="hidden" id="${hiddenInputId}" name="${hiddenInputId}">`);

                        // Ensure that the newly appended select dropdown is functional
                        $('#' + selectId).on('change', function () {
                            // Update the corresponding hidden input field whenever the dropdown changes
                            $('#' + hiddenInputId).val($(this).val());
                        });
                    } else {
                        var tagInfo = `<p><strong>${tag}</strong>: No semantic tag found</p>`;
                        tagInfoDiv.append(tagInfo);
                    }
                },
                error: function () {
                    var tagInfo = `<p><strong>${tag}</strong>: Error retrieving semantic tag</p>`;
                    tagInfoDiv.append(tagInfo);
                }
            });
        });
    }
</script>
